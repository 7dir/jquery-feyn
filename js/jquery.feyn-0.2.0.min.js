// jQuery.Feyn v0.2.0 | (c) 2013 Zan Pan, MIT license
!function(a){"use strict";a.fn.feyn=function(c){return this.each(function(){if(!a(this).data("feyn"))try{a(this).html(new b(this,c).svgOutput()),a(this).data("feyn",!0)}catch(d){a(this).html("JavaScript "+d.name+": "+d.message)}})};var b=function(c,d){b.counter=(b.counter||0)+1,b.prefix="feyn"+(b.counter>1?b.counter:"");var e=a.extend(!0,{xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink",version:"1.1",x:0,y:0,width:200,height:200,title:"",description:"Feynman diagram generated by jQuery.Feyn",standalone:!1,selector:!1,grid:{show:!1,unit:20},color:"black",thickness:1.6,tension:1,ratio:1,clockwise:!1,incoming:{},outgoing:{},vertex:{},auxiliary:{},fermion:{arrow:!0},photon:{period:5,amplitude:5},scalar:{arrow:!1,dash:"5 5",offset:2},ghost:{arrow:!0,thickness:3,dotsep:8,offset:5},gluon:{width:15,height:15,factor:.75,percent:.6,scale:1.15},symbol:{},node:{show:!1,thickness:1,radius:3,type:"dot",fill:"white"},label:{family:"Georgia",size:15,face:"italic"},image:{},ajax:!1},d),f=Math.PI,g={fill:"none",color:e.color,thickness:e.thickness},h={fermion:{},photon:{},gluon:{},scalar:{dash:e.scalar.dash,offset:e.scalar.offset},ghost:{dash:"0.1 "+e.ghost.dotsep,offset:e.ghost.offset}};for(var i in h)h[i]=a.extend(!0,{},g,{color:e[i].color,thickness:e[i].thickness,linecap:"round"},h[i]);var j=a.extend({},e.incoming,e.outgoing,e.vertex,e.auxiliary);for(i in j)j[i]=j[i].replace(/\s/g,"").split(",");var k={fermion:{},photon:{},scalar:{},ghost:{},gluon:{}};for(var l in k){k[l]=a.extend({},e[l]);for(i in k[l])if(i.match(/line|arc|loop/)){k[l][i]=k[l][i].replace(/\s/g,"").split(",");for(var m in k[l][i])k[l][i][m]=k[l][i][m].replace(/-+/g,"-").split("-")}else delete k[l][i]}var n={sty:{fill:e.label.fill||e.label.color||g.color,color:e.label.color||g.color,thickness:e.label.thickness||0,family:e.label.family,size:e.label.size,weight:e.label.weight,face:e.label.face,align:e.label.align||"middle"},pos:e.label};for(i in n.pos)n.sty[i]&&delete n.pos[i];var o={defs:[],body:[],tags:["path","line","rect","circle","ellipse","polygon","polyline","image","use"],attr:{xlink:"xmlns:xlink",href:"xlink:href",color:"stroke",thickness:"stroke-width",dash:"stroke-dasharray",linecap:"stroke-linecap",linejoin:"stroke-linejoin",offset:"stroke-dashoffset",family:"font-family",size:"font-size",face:"font-style",weight:"font-weight",align:"text-anchor"}},p=function(b,c,d,e){var f="";c=a.extend({},c,d);for(var g in c)f+=" "+(o.attr[g]||g)+'="'+c[g]+'"';return"<"+b+f+(o.tags.indexOf(b)>=0?"/>":">"+(b.match(/title|desc|tspan/)?"":"\n")+(e?e.replace(/</g,"  <").replace(/\s+<\/(title|desc|tspan)/g,"</$1"):"")+"</"+b+">")+"\n"},q=function(){for(var d,a="",b=0,c=arguments.length;c>b;b++)d=arguments[b],a+="number"!=typeof d?d:d.toFixed(3).replace(/(.\d*?)0+$/,"$1").replace(/\.$/,"");return a},r=function(a){return e.selector?{id:b.prefix+"_"+a}:{}},s=function(a){return e.selector?{"class":a}:{}},t=function(a,b,c,d){var e=c-a,f=d-b;return{angle:Math.atan2(f,e),distance:Math.sqrt(e*e+f*f)}},u=function(a,b,c){return"translate("+q(a,",",b)+")"+(c?" rotate("+q(180*c/f)+")":"")},v=function(a,b,c,d,e,f){var g=Math.atan2(d-b,c-a);return q(e*Math.cos(g)-f*Math.sin(g)+a,",",e*Math.sin(g)+f*Math.cos(g)+b)},w=function(b,c,d,f,g){var i="ghost"==b?h.fermion.thickness:h[b].thickness;return e[b].arrow?p("polygon",a.extend({points:q("0,0 ",-2*i,",",2.5*i," ",3*i,",0 ",-2*i,",",-2.5*i)},{transform:u(c,d,f)}),r(g)):""},x=function(b,c,d){for(var e=["M"],f=Math.floor(d/c),g=d-c*f+.1,h=0;f>=h;h++)for(var k,i=0,j=b.length;j>i;i++)if(k=b[i],a.isArray(k)){if(!(f>h||k[0]<g))break;e.push(q(k[0]+c*h,",",k[1]))}else e.push(k);return e.join(" ").replace(/\s[A-Z][^A-Z]*$/,"")},y=function(b,c,d,g){for(var h=.25*Math.max(e[b].tension||e.tension,2),i=Math.acos(-.5/h),j=-2*Math.asin(d/(h*g)),k=[],l=["M","0,0"],m=0;(f-2*i)/j>=m;m++)k.push([g*(h*Math.cos(j*m+i)+.5),g*(h*Math.sin(j*m+i)-Math.sqrt(h*h-.25))]);for(var p,n=0,o=k.length-1;o>n;n++){p="photon"==b?c[n%2]:c;for(var s,q=0,r=p.length;r>q;q++)s=p[q],l.push(a.isArray(s)?v(k[n][0],k[n][1],k[n+1][0],k[n+1][1],s[0],s[1]):s)}return l.join(" ").replace(/\s[A-Z]$/,"")},z=function(b,c,d,g){for(var h=2*Math.asin(2*d/g),i=2*f/h,j=[],k=e[b].clockwise?-.5:.5,l=["M","gluon"==b?k+",0":"0,"+k],m=-.1,n=g;Math.floor(i)%4||i-Math.floor(i)>.1;m+=.001)g=(1+m)*n,h=2*Math.asin(2*d/g),i=2*f/h;for(var o=0;i>=o;o++)j.push([.5*g*(1-Math.cos(h*o)),.5*g*Math.sin(h*o)]);for(var r,p=0,q=j.length-1;q>p;p++){r="photon"==b?c[p%2]:c;for(var u,s=0,t=r.length;t>s;s++)u=r[s],l.push(a.isArray(u)?v(j[p][0],j[p][1],j[p+1][0],j[p+1][1],u[0],u[1]):u)}return l.join(" ").replace(/\s[A-Z]$/,"")+" Z"},A=function(a,b){var c=e.photon.amplitude,d=e.photon.period,g=e.photon.clockwise||e.clockwise,h=g?[[0,0],"C",[2,-f*c/d],[d-2,-c],[d,-c],"S",[2*d-2,-f*c/d],[2*d,0],"S",[3*d-2,c],[3*d,c],"S",[4*d-2,f*c/d]]:[[0,0],"C",[2,f*c/d],[d-2,c],[d,c],"S",[2*d-2,f*c/d],[2*d,0],"S",[3*d-2,-c],[3*d,-c],"S",[4*d-2,-f*c/d]],i=g?[["C",[2,-f*c/d],[d-2,-c],[d,-c],"S",[2*d-2,-f*c/d],[2*d+.5,0]],["C",[2,f*c/d],[d-2,c],[d,c],"S",[2*d-2,f*c/d],[2*d-.5,0]]]:[["C",[2,f*c/d],[d-2,c],[d,c],"S",[2*d-2,f*c/d],[2*d-.5,0]],["C",[2,-f*c/d],[d-2,-c],[d,-c],"S",[2*d-2,-f*c/d],[2*d+.5,0]]];return{line:x(h,4*d,a),arc:y("photon",i,d,a),loop:z("photon",i,d,a)}[b]},B=function(a,b){var c=4*(Math.SQRT2-1)/3,d=e.gluon.height*e.gluon.factor,f=e.gluon.width*e.gluon.percent,g=e.gluon.height*(e.gluon.factor-.5),h=e.gluon.width*(1-e.gluon.percent),i=e.gluon.clockwise||e.clockwise,j=i?[[0,0],"A "+d+" "+f,0,0,1,[d,f],"A "+g+" "+h,0,1,1,[d-2*g,f],"A "+d+" "+f,0,0,1]:[[0,0],"A "+d+" "+f,0,0,0,[d,-f],"A "+g+" "+h,0,1,0,[d-2*g,-f],"A "+d+" "+f,0,0,0];d=i?d:e.gluon.scale*d;var k=d/Math.pow(a,.6),l=i?["C",[c*d,k],[d,f-c*f],[d,f],"C",[d,f+c*h],[d-g+c*g,f+h],[d-g,f+h],"S",[d-2*g,f+c*h],[d-2*g,f],"C",[d-2*g,f-c*f],[2*(d-g)-c*d,0],[2*(d-g),-k]]:["C",[c*d,k],[d,-f+c*f],[d,-f],"C",[d,-f-c*h],[d-g+c*g,-f-h],[d-g,-f-h],"S",[d-2*g,-f-c*h],[d-2*g,-f],"C",[d-2*g,-f+c*f],[2*(d-g)-c*d,0],[2*(d-g),-k]];return{line:x(j,e.gluon.height,a),arc:y("gluon",l,d-g,a),loop:z("gluon",l,d-g,a)}[b]},C=function(a,b,c,d,e,f){var g={photon:A,gluon:B},h=r(f+"_line"),i=t(a,b,c,d);return e.match(/photon|gluon/)?[p("path",{d:g[e](i.distance,"line"),transform:u(a,b,i.angle)},h),""]:[p("line",{x1:a,y1:b,x2:c,y2:d},h),w(e,.5*(a+c),.5*(b+d),i.angle,f+"_line_arrow")]},D=function(a,b,c,d,g,h){var i={photon:A,gluon:B},j=r(h+"_arc"),k=t(a,b,c,d),l=.5*Math.max(e[g].tension||e.tension,1),m=l-Math.sqrt(Math.abs(l*l-.25)),n=k.distance,o=k.angle,s=m*n*Math.sin(o),v=m*n*Math.cos(o),x=e[g].clockwise||e.clockwise;return g.match(/photon|gluon/)?[p("path",{d:i[g](n,"arc"),transform:u(a,b,o)},j),""]:[p("path",{d:q("M 0,0 A ",l*n," ",l*n," 0 0 1 ",n,",0"),transform:u(a,b,o)},j),w(g,.5*(a+c)+s,.5*(b+d)-v,o+(x?f:0),h+"_arc_arrow")]},E=function(a,b,c,d,g,h){var i={photon:A,gluon:B},j=r(h+"_loop"),k=h+"_loop_arrow_",l=t(a,b,c,d),m=e[g].ratio||e.ratio,n=.5*l.distance,o=l.angle,s=m*n*Math.sin(o),v=m*n*Math.cos(o),x=e[g].clockwise||e.clockwise;return g.match(/photon|gluon/)?[p("path",{d:i[g](2*n,"loop"),transform:u(a,b,o)},j),""]:[p("ellipse",{cx:q(n),cy:0,rx:q(n),ry:q(m*n),transform:u(a,b,o)},j),w(g,.5*(a+c)+s,.5*(b+d)-v,o+(x?f:0),k+"1")+w(g,.5*(a+c)-s,.5*(b+d)+v,o+(x?0:f),k+"2")]},F=function(){var a=[],b=[],c=[],d={line:C,arc:D,loop:E};for(var f in k){var g=[],i="",l="";for(var m in k[f])for(var n in k[f][m]){b=k[f][m][n],c[0]=j[b[0]];for(var o=1,q=b.length;q>o;o++)c[o]=j[b[o]],g=d[m](+c[o-1][0],+c[o-1][1],+c[o][0],+c[o][1],f,b[o-1]+"_"+b[o]),i+=g[0],l+=g[1]}a.push(i?p("g",s(f),h[f],i+(e[f].arrow?p("g",s(f+"_"+"arrow"),{fill:h[f].color,thickness:0},l):"")):"")}return a.join("")},G=function(){var b=a.extend({},g,{color:e.symbol.color,thickness:e.symbol.thickness}),c=b.thickness,d=0,h="";delete e.symbol.color,delete e.symbol.thickness;for(var i in e.symbol){var k=e.symbol[i],l=j[k[0]]||k[0].replace(/\s/g,"").split(","),m={transform:u(l[0],l[1],k[1]*f/180)},n=k[2],o=k[3],t=k[4]||0,w=k[5],x=r(i+"_"+n),y="0,0";if("arrow"==n)d=2*t>o?Math.sqrt(t*t-o*o/4):2*t==o?1:0;else if("zigzag"==n)for(var z=0;.5*o/t>=z;z++)y+=q(" ",t*(2*z+1),",",(e.tension+.2)*t*(1-2*(z%2))," ",2*t*(z+1),",0");h+={arrow:p("g",m,x,p("path",{d:d?q("M 0,0 A ",t," ",t," 0 0 1 ",o,",0"):q("M 0,0 L ",o,",0")})+p("polygon",{points:d?w?q("0,0 ")+v(0,0,-2*d*d/o,d,-2*c,2.5*c)+" "+v(0,0,-2*d*d/o,d,3*c,0)+" "+v(0,0,-2*d*d/o,d,-2*c,-2.5*c):q(o,",0 ")+v(o,0,o+2*d*d/o,d,-2*c,2.5*c)+" "+v(o,0,o+2*d*d/o,d,3*c,0)+" "+v(o,0,o+2*d*d/o,d,-2*c,-2.5*c):q(o,",0 ",o-2*c,",",2.5*c," ",o+3*c,",0 ",o-2*c,",",-2.5*c)},{fill:b.color,thickness:0})),blob:w?p("path",a.extend({d:q("M ",t,",",-t," A ",t," ",t," 0 1 0 ",t,",",t," L ",2*o,",",t," A ",t," ",t," 0 1 0 ",2*o,",",-t," L ",t,",",-t," Z")},m),a.extend({fill:"silver"},x)):p("ellipse",a.extend({cx:o,cy:0,rx:o,ry:t},m),a.extend({fill:"silver"},x)),bubble:p("path",a.extend({d:q("M 0,0 C ",t,",",t," ",o,",",t," ",o,",0 S ",t,",",-t," 0,0 Z")},m),x),condensate:p("g",m,a.extend({fill:"black"},x),p("rect",{x:-.5*o,y:-t,width:o,height:2*t},{fill:"white",thickness:0})+p("circle",{cx:-.5*o,cy:0,r:t})+p("circle",{cx:.5*o,cy:0,r:t})),hadron:p("g",m,x,p("path",{d:q("M 0,0 L ",o,",0"," M 0,",t," L ",o,",",t," M 0,",-t," L ",o,",",-t)})+p("polygon",{points:w?q(o,",",2*t," ",o+3.6*t,",0 ",o,",",-2*t):q(.5*o-1.6*t,",",2*t," ",.5*o+2*t,",0 ",.5*o-1.6*t,",",-2*t)},{fill:"white"})),meson:p("g",m,x,p("path",{d:q("M 0,",-.5*t," L ",o,",",-.5*t," M 0,",.5*t," L ",o,",",.5*t)})+(w?"":p("polygon",{points:q(.5*o-t,",",1.25*t," ",.5*o+1.25*t,",0 ",.5*o-t,",",-1.25*t)},{fill:"white"}))),zigzag:p("polyline",a.extend({points:y},m),x)}[n]}return h?p("g",s("symbol"),b,h):""},H=function(){var b=e.node.show===!0?"iova":e.node.show,c=e.node.type,d=a.extend({},g,{fill:e.node.fill,color:e.node.color,thickness:e.node.thickness}),f=e.node.radius+d.thickness,h=f/Math.SQRT2-("cross"==c?0:d.thickness),i="";for(var k in j)if(b.indexOf(k.charAt(0))>=0){var l=r(k+"_"+c),m=+j[k][0],n=+j[k][1],o={d:q("M ",-h,",",-h," L ",h,",",h," M ",-h,",",h," L ",h,",",-h),transform:u(m,n,0)};i+={cross:p("path",o,l),dot:p("circle",{cx:m,cy:n,r:f},l),otimes:p("g",{},l,p("circle",{cx:m,cy:n,r:f})+p("path",o))}[c]}return i?p("g",s("node"),d,i):""},I=function(a){a=a.replace(/[\s\{\}]+/g,"").replace(/(_[^_]+)(\^[^\^]+)/g,"$2$1");var b=n.sty.size,c=Math.round(.8*b),d=a.charAt(0),e=a.indexOf("^")+1,f=a.indexOf("_")+1,g=e?e:f,h=-.15*b,i=.4*b;return(d.match(/-|~/)?p("tspan",{dx:q("0 ",4*h),dy:q(-i," ",i)},{},("-"==d?"&#8211;":d)+(g?a.slice(1,g-1):a.slice(1))):p("tspan",{},{},g?a.slice(0,g-1):a.slice(0)))+(e?p("tspan",{dx:q(h),dy:q(-i)},{size:c},f?a.slice(e,f-1):a.slice(e)):"")+(f?p("tspan",{dx:q((e?5:1)*h),dy:q((e?2:1)*i)},{size:c},a.slice(f)):"")},J=function(){var a="";for(var b in n.pos){var c=n.pos[b],d=j[c[0]]||c[0].replace(/\s/g,"").split(",");a+=p("text",{x:q(d[0]),y:q(d[1])},r(b),I(c[1]))}return a?p("g",s("label"),n.sty,a):""},K=function(){var b="";for(var c in e.image){var d=e.image[c],f=j[d[0]]||d[0].replace(/\s/g,"").split(","),g=q(f[0]),h=q(f[1]),i=r(c);e.ajax?a.ajax({url:d[1],dataType:"text",async:!1,success:function(a){a=a.replace(/<\?.*\?>\n*/,""),a=a.slice(0,a.search(">")).replace(/ x=.\d+./,"").replace(/ y=.\d+./,"")+a.slice(a.search(">")),b+=a.replace(/>/,' x="'+g+'" y="'+h+'">').replace(/(id=.)/g,"$1"+i.id+"_").replace(/(href=.#)/g,"$1"+i.id+"_")},error:function(){throw new Error("fail to load "+d[1])}}):b+=p("image",{href:d[1],x:g,y:h},a.extend({width:d[2]||32,height:d[3]||32},d[3]?{}:{preserveAspectRatio:"xMinYMin meet"},i))}return b?p("g",s("image"),{},b):""};this.svgOutput=function(){if(!document.createElementNS||!document.createElementNS(e.xmlns,"svg").createSVGRect)return"Your browser does not support SVG.";if(e.grid.show){var d=e.grid.unit;o.defs.push(p("pattern",{x:0,y:0,width:d,height:d,viewBox:"0 0 "+d+" "+d},{patternUnits:"userSpaceOnUse",id:b.prefix+"_grid"},p("polyline",{points:d+",0 0,0 0,"+d},{fill:"none",color:"silver"}))),o.body.push(p("rect",{x:0,y:0,width:"100%",height:"100%"},{fill:"url(#"+b.prefix+"_grid)",color:"silver"}))}o.body.push(F()+G()),e.node.show&&o.body.push(H()),o.body.push(J()+K());var f=p("svg",{xmlns:e.xmlns,xlink:e.xlink,version:e.version,x:e.x,y:e.y,width:e.width,height:e.height},e.selector?{id:b.prefix}:{},(e.title?p("title",{},{},e.title):"")+(e.description?p("desc",{},{},e.description):"")+(o.defs.length?p("defs",{},{},o.defs.join("")):"")+(o.body.length?o.body.join(""):""));if(e.standalone){var g='<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n'+f;f='<div class="feyn" style="display:inline-block;margin-right:5px;">'+f+'</div><textarea cols="80" spellcheck="false"'+' style="padding:3px;height:'+(e.height-8)+'px;">'+g.replace(/&/g,"&#38;").replace(/"(.+?)"/g,"&#34;$1&#34;").replace(/</g,"&#60;").replace(/>/g,"&#62;")+"</textarea>",a(c).change(function(){f=a(this).children("textarea").val(),a(this).children(".feyn").html(f.slice(f.search("<svg")))})}return f}}}(jQuery);
