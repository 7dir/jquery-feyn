// jQuery.Feyn v0.1.0 | (c) 2013 Zan Pan, MIT license
!function(a){"use strict";a.fn.feyn=function(c){return this.each(function(){if(!a(this).data("feyn"))try{a(this).html(new b(this,c).svgOutput()),a(this).data("feyn",!0)}catch(d){a(this).html("JavaScript "+d.name+": "+d.message)}})};var b=function(c,d){b.counter=(b.counter||0)+1,b.prefix="feyn"+(b.counter>1?b.counter:"");var e=a.extend(!0,{xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink",version:"1.1",x:0,y:0,width:200,height:200,title:"",description:"Feynman diagram generated by jQuery.Feyn",standalone:!1,selector:!1,grid:{show:!1,unit:20},color:"black",thickness:1.6,tension:1.6,ratio:.6,incoming:{},outgoing:{},vertex:{},auxiliary:{},fermion:{arrow:!0},photon:{clockwise:!1,period:5,amplitude:5},scalar:{arrow:!1,dash:"5 5",offset:2},ghost:{arrow:!0,thickness:3,dotsep:8,offset:5},gluon:{clockwise:!1,width:15,height:15,factor:.75,percent:.6,scale:1.15},node:{show:!1,thickness:1,radius:3,type:"dot",fill:"white"},symbol:{},label:{family:"serif",size:"15",face:"italic"},image:{},ajax:!1},d),f=Math.PI,g={color:e.color,thickness:e.thickness},h={fermion:{},photon:{fill:"none"},scalar:{dash:e.scalar.dash,offset:e.scalar.offset},ghost:{dash:"0.1 "+e.ghost.dotsep,offset:e.ghost.offset},gluon:{fill:"none"}};for(var i in h)h[i]=a.extend(!0,{},g,{color:e[i].color,thickness:e[i].thickness,linecap:"round"},h[i]);var j=a.extend({},e.incoming,e.outgoing,e.vertex,e.auxiliary);for(i in j)j[i]=j[i].replace(/\s/g,"").split(",");var k={fermion:{},photon:{},scalar:{},ghost:{},gluon:{}};for(var l in k){k[l]=a.extend({},e[l]);for(i in k[l])if(i.match(/line|arc|loop/)){k[l][i]=k[l][i].replace(/\s/g,"").split(",");for(var m in k[l][i])k[l][i][m]=k[l][i][m].replace(/-+/g,"-").split("-")}else delete k[l][i]}var n={sty:{color:e.label.color||g.color,thickness:e.label.thickness||0,fill:e.label.fill||e.label.color||g.color,family:e.label.family,size:e.label.size,weight:e.label.weight,face:e.label.face,anchor:e.label.anchor||"middle"},pos:e.label};for(i in n.pos)n.sty[i]&&delete n.pos[i];var o={defs:[],body:[],tags:["line","rect","circle","ellipse","path","polyline","polygon","image","use"],attr:{xlink:"xmlns:xlink",href:"xlink:href",color:"stroke",thickness:"stroke-width",dash:"stroke-dasharray",linecap:"stroke-linecap",linejoin:"stroke-linejoin",offset:"stroke-dashoffset",family:"font-family",size:"font-size",face:"font-style",weight:"font-weight",anchor:"text-anchor"}},p=function(b,c,d,e){var f="";c=a.extend({},c,d);for(var g in c)f+=" "+(o.attr[g]||g)+'="'+c[g]+'"';return"<"+b+f+(o.tags.indexOf(b)>=0?"/>":">"+(b.match(/title|desc|tspan/)?"":"\n")+(e?e.replace(/</g,"  <").replace(/\s+<\/(title|desc|tspan)/g,"</$1"):"")+"</"+b+">")+"\n"},q=function(){for(var d,a="",b=0,c=arguments.length;c>b;b++)d=arguments[b],a+="number"!=typeof d?d:d.toFixed(3).replace(/(.\d*?)0+$/,"$1").replace(/\.$/,"");return a},r=function(a){return e.selector?{id:b.prefix+"_"+a}:{}},s=function(a){return e.selector?{"class":a}:{}},t=function(a,b,c,d){var e=c-a,f=d-b;return{angle:Math.atan2(f,e),distance:Math.sqrt(Math.pow(e,2)+Math.pow(f,2))}},u=function(a,b,c){return"translate("+q(a,",",b)+")"+(c?" rotate("+q(180*c/f)+")":"")},v=function(a,b,c,d,e,f){var g=Math.atan2(d-b,c-a);return q(e*Math.cos(g)-f*Math.sin(g)+a,",",e*Math.sin(g)+f*Math.cos(g)+b)},w=function(b,c,d,f,g){var i="ghost"==b?h.fermion.thickness:h[b].thickness;return e[b].arrow?p("polygon",a.extend({points:q("0,0 ",-2*i,",",2.5*i," ",3*i,",0 ",-2*i,",",-2.5*i)},{transform:u(c,d,f)}),r(g)):""},x=function(b,c,d){for(var e=["M"],f=Math.floor(d/c),g=d-c*f+.1,h=0;f>=h;h++)for(var k,i=0,j=b.length;j>i;i++)if(k=b[i],a.isArray(k)){if(!(f>h||k[0]<g))break;e.push(q(k[0]+c*h,",",k[1]))}else e.push(k);return e.join(" ").replace(/\s[A-Z][^A-Z]*$/,"")},y=function(b,c,d,g){for(var h=.25*Math.max(e[b].tension||e.tension,2)+.001,i=Math.acos(-.5/h),j=-2*Math.asin(d/(h*g)),k=[],l=["M","0,0"],m=0;(f-2*i)/j>=m;m++)k.push([g*(h*Math.cos(j*m+i)+.5),g*(h*Math.sin(j*m+i)-Math.sqrt(h*h-.25))]);for(var p,n=0,o=k.length-1;o>n;n++){p="photon"==b?c[n%2]:c;for(var s,q=0,r=p.length;r>q;q++)s=p[q],l.push(a.isArray(s)?v(k[n][0],k[n][1],k[n+1][0],k[n+1][1],s[0],s[1]):s)}return l.join(" ").replace(/\s[A-Z]$/,"")},z=function(b,c,d,g){for(var h=2*Math.asin(2*d/g),i=2*f/h,j=[],k=e[b].clockwise?-.5:.5,l=["M","gluon"==b?k+",0":"0,"+k],m=-.1,n=g;Math.floor(i)%4||i-Math.floor(i)>.1;m+=.001)g=(1+m)*n,h=2*Math.asin(2*d/g),i=2*f/h;for(var o=0;i>=o;o++)j.push([.5*g*(1-Math.cos(h*o)),.5*g*Math.sin(h*o)]);for(var r,p=0,q=j.length-1;q>p;p++){r="photon"==b?c[p%2]:c;for(var u,s=0,t=r.length;t>s;s++)u=r[s],l.push(a.isArray(u)?v(j[p][0],j[p][1],j[p+1][0],j[p+1][1],u[0],u[1]):u)}return l.join(" ").replace(/\s[A-Z]$/,"")+" Z"},A=function(a,b){var c=e.photon.amplitude,d=e.photon.period,g=e.photon.clockwise?[[0,0],"C",[2,-f*c/d],[d-2,-c],[d,-c],"S",[2*d-2,-f*c/d],[2*d,0],"S",[3*d-2,c],[3*d,c],"S",[4*d-2,f*c/d]]:[[0,0],"C",[2,f*c/d],[d-2,c],[d,c],"S",[2*d-2,f*c/d],[2*d,0],"S",[3*d-2,-c],[3*d,-c],"S",[4*d-2,-f*c/d]],h=e.photon.clockwise?[["C",[2,-f*c/d],[d-2,-c],[d,-c],"S",[2*d-2,-f*c/d],[2*d+.5,0]],["C",[2,f*c/d],[d-2,c],[d,c],"S",[2*d-2,f*c/d],[2*d-.5,0]]]:[["C",[2,f*c/d],[d-2,c],[d,c],"S",[2*d-2,f*c/d],[2*d-.5,0]],["C",[2,-f*c/d],[d-2,-c],[d,-c],"S",[2*d-2,-f*c/d],[2*d+.5,0]]];return{line:x(g,4*d,a),arc:y("photon",h,d,a),loop:z("photon",h,d,a)}[b]},B=function(a,b){var c=4*(Math.SQRT2-1)/3,d=e.gluon.height*e.gluon.factor,f=e.gluon.width*e.gluon.percent,g=e.gluon.height*(e.gluon.factor-.5),h=e.gluon.width*(1-e.gluon.percent),i=e.gluon.clockwise?[[0,0],"A "+d+" "+f,0,0,1,[d,f],"A "+g+" "+h,0,1,1,[d-2*g,f],"A "+d+" "+f,0,0,1]:[[0,0],"A "+d+" "+f,0,0,0,[d,-f],"A "+g+" "+h,0,1,0,[d-2*g,-f],"A "+d+" "+f,0,0,0];d=e.gluon.clockwise?d:(e.gluon.scale+.01)*d;var j=d/Math.pow(a,.6),k=e.gluon.clockwise?["C",[c*d,j],[d,f-c*f],[d,f],"C",[d,f+c*h],[d-g+c*g,f+h],[d-g,f+h],"S",[d-2*g,f+c*h],[d-2*g,f],"C",[d-2*g,f-c*f],[2*(d-g)-c*d,0],[2*(d-g),-j]]:["C",[c*d,j],[d,-f+c*f],[d,-f],"C",[d,-f-c*h],[d-g+c*g,-f-h],[d-g,-f-h],"S",[d-2*g,-f-c*h],[d-2*g,-f],"C",[d-2*g,-f+c*f],[2*(d-g)-c*d,0],[2*(d-g),-j]];return{line:x(i,e.gluon.height,a),arc:y("gluon",k,d-g,a),loop:z("gluon",k,d-g,a)}[b]},C=function(a,b,c,d,e,f){var g={photon:A,gluon:B},h=r(f+"_line"),i=t(a,b,c,d);return e.match(/photon|gluon/)?[p("path",{d:g[e](i.distance,"line"),transform:u(a,b,i.angle)},h),""]:[p("line",{x1:a,y1:b,x2:c,y2:d},h),w(e,.5*(a+c),.5*(b+d),i.angle,f+"_line_arrow")]},D=function(b,c,d,f,g,h){var i={photon:A,gluon:B},j=r(h+"_arc"),k=a.extend({fill:"none"},j),l=t(b,c,d,f),m=.5*Math.max(e[g].tension||e.tension,1),n=m-Math.sqrt(Math.abs(m*m-.25)),o=l.distance,s=n*o*Math.sin(l.angle),v=n*o*Math.cos(l.angle);return g.match(/photon|gluon/)?[p("path",{d:i[g](l.distance,"arc"),transform:u(b,c,l.angle)},j),""]:[p("path",{d:q("M 0,0 A ",m*o," ",m*o," 0 0 1 ",o,",0"),transform:u(b,c,l.angle)},k),w(g,.5*(b+d)+s,.5*(c+f)-v,l.angle,h+"_arc_arrow")]},E=function(b,c,d,g,h,i){var j={photon:A,gluon:B},k=r(i+"_loop"),l=a.extend({fill:"none"},k),m=t(b,c,d,g),n=e[h].ratio||e.ratio,o=.5*m.distance,s=n*o*Math.sin(m.angle),v=n*o*Math.cos(m.angle);return h.match(/photon|gluon/)?[p("path",{d:j[h](m.distance,"loop"),transform:u(b,c,m.angle)},k),""]:[p("ellipse",{cx:q(o),cy:0,rx:q(o),ry:q(n*o),transform:u(b,c,m.angle)},l),w(h,.5*(b+d)+s,.5*(c+g)-v,m.angle,i+"_loop_arrow_1")+w(h,.5*(b+d)-s,.5*(c+g)+v,f+m.angle,i+"_loop_arrow_2")]},F=function(){var a=[],b=[],c=[],d={line:C,arc:D,loop:E};for(var f in k){var g=[],i="",l="";for(var m in k[f])for(var n in k[f][m]){b=k[f][m][n],c[0]=j[b[0]];for(var o=1,q=b.length;q>o;o++)c[o]=j[b[o]],g=d[m](+c[o-1][0],+c[o-1][1],+c[o][0],+c[o][1],f,b[o-1]+"_"+b[o]),i+=g[0],l+=g[1]}a.push(i?p("g",s(f),h[f],i+(e[f].arrow?p("g",s(f+"_"+"arrow"),{thickness:0,fill:h[f].color},l):"")):"")}return a.join("")},G=function(){var b=e.node.type,c=a.extend({},g,{color:e.node.color,thickness:e.node.thickness,fill:e.node.fill}),d=e.node.radius+c.thickness,f=d/Math.SQRT2,h=q("M ",-f,",",-f," L ",f,",",f," M ",-f,",",f," L ",f,",",-f),i="";for(var k in j)if(e.node.show.indexOf(k.charAt(0))>=0){var l=r(k+"_"+b),m=+j[k][0],n=+j[k][1];i+={dot:p("circle",{cx:m,cy:n,r:d},l),otimes:p("g",{},l,p("circle",{cx:m,cy:n,r:d})+p("path",{d:h,transform:u(m,n,0)}))}[b]}return i?p("g",s("node"),c,i):""},H=function(){var b={fill:"none"},c=g.thickness,d="";for(var h in e.symbol){var i=e.symbol[h],k=j[i[0]]||i[0].replace(/\s/g,"").split(","),l={transform:u(k[0],k[1],i[1]*f/180)},m=i[2][0],n=i[2][1],o=i[3],t=r(h+"_"+m),v=["0,0"];if("zigzag"==m)for(var w=0;.5*o/n>=w;w++)v.push(q(n*(2*w+1),",",(e.tension+.2)*n*(1-2*(w%2))),q(2*n*(w+1),",0"));d+={zigzag:p("polyline",a.extend({points:v.join(" ")},l),a.extend({},b,t)),arrow:p("g",l,t,p("path",{d:n>o?q("M 0,0 A ",n," ",n," 0 0 1 ",o,",0"):q("M 0,0 L ",o,",0")},b)+p("polygon",{points:q(o,",0 ",o-2*c,",",2.5*c," ",o+3*c,",0 ",o-2*c,",",-2.5*c)},{thickness:0,fill:g.color})),hadron:p("g",l,t,p("path",{d:q("M 0,0 L ",o,",0"," M 0,",n," L ",o,",",n," M 0,",-n," L ",o,",",-n)},{})+p("polygon",{points:q(o,",",2*n," ",o+3.5*n,",0 ",o,",",-2*n)},{fill:"white"})),bubble:p("path",a.extend({d:q("M 0,0 C ",n,",",n," ",o,",",n," ",o,",0 S ",n,",",-n," "," 0,0 Z")},l),a.extend({},b,t))}[m]}return d?p("g",s("symbol"),g,d):""},I=function(a){a=a.replace(/[\s\{\}]+/g,"").replace(/(_[^_]+)(\^[^\^]+)/g,"$2$1");var b=n.sty.size,c=Math.round(.8*b),d=a.charAt(0),e=a.indexOf("^")+1,f=a.indexOf("_")+1,g=e?e:f,h=-.15*b,i=.4*b,j="";return j+=d.match(/-|~/)?p("tspan",{dx:q("0 ",4*h),dy:q(-i," ",i)},{},("-"==d?"&#8211;":d)+(g?a.slice(1,g-1):a.slice(1))):p("tspan",{},{},g?a.slice(0,g-1):a.slice(0)),j+=e?p("tspan",{dx:q(h),dy:q(-i)},{size:c},f?a.slice(e,f-1):a.slice(e)):"",j+=f?p("tspan",{dx:q((e?5:1)*h),dy:q((e?2:1)*i)},{size:c},a.slice(f)):""},J=function(){var a="";for(var b in n.pos){var c=n.pos[b],d=j[c[0]]||c[0].replace(/\s/g,"").split(",");a+=p("text",{x:q(d[0]),y:q(d[1])},r(b),I(c[1]))}return a?p("g",s("label"),n.sty,a):""},K=function(){var b="";for(var c in e.image){var d=e.image[c],f=j[d[0]]||d[0].replace(/\s/g,"").split(","),g=q(f[0]),h=q(f[1]),i=r(c);e.ajax?a.ajax({url:d[1],dataType:"text",async:!1,success:function(a){a=a.replace(/<\?.*\?>\n*/,""),a=a.slice(0,a.search(">")).replace(/ x=.\d+./,"").replace(/ y=.\d+./,"")+a.slice(a.search(">")),b+=a.replace(/>/,' x="'+g+'" y="'+h+'">').replace(/(id=.)/g,"$1"+i.id+"_").replace(/(href=.#)/g,"$1"+i.id+"_")},error:function(){throw new Error("fail to load "+d[1])}}):b+=p("image",{href:d[1],x:g,y:h},a.extend({width:d[2]||32,height:d[3]||32},d[3]?{}:{preserveAspectRatio:"xMinYMin meet"},i))}return b?p("g",s("image"),{},b):""};this.svgOutput=function(){if(!document.createElementNS||!document.createElementNS(e.xmlns,"svg").createSVGRect)return"Your browser does not support SVG.";if(e.grid.show){var d=e.grid.unit;o.defs.push(p("pattern",{x:0,y:0,width:d,height:d,viewBox:"0 0 "+d+" "+d},{patternUnits:"userSpaceOnUse",id:b.prefix+"_grid"},p("polyline",{points:d+",0 0,0 0,"+d},{color:"silver",fill:"none"}))),o.body.push(p("rect",{x:0,y:0,width:"100%",height:"100%"},{color:"silver",fill:"url(#"+b.prefix+"_grid)"}))}o.body.push(F()+H()),e.node.show&&o.body.push(G()),o.body.push(J()+K());var f=p("svg",{xmlns:e.xmlns,xlink:e.xlink,version:e.version,x:e.x,y:e.y,width:e.width,height:e.height},{id:b.prefix},(e.title?p("title",{},{},e.title):"")+(e.description?p("desc",{},{},e.description):"")+(o.defs.length?p("defs",{},{},o.defs.join("")):"")+(o.body.length?o.body.join(""):""));if(e.standalone){var g='<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n'+f;f='<div class="feyn" style="display:inline-block;margin-right:5px;">'+f+'</div><textarea cols="80" spellcheck="false"'+' style="padding:3px;height:'+(e.height-8)+'px;">'+g.replace(/&/g,"&#38;").replace(/"(.+?)"/g,"&#34;$1&#34;").replace(/</g,"&#60;").replace(/>/g,"&#62;")+"</textarea>",a(c).change(function(){f=a(this).children("textarea").val(),a(this).children(".feyn").html(f.slice(f.search("<svg")))})}return f}}}(jQuery);
